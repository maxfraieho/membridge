---
tags:
  - domain:runtime
  - status:canonical
  - layer:operations
  - format:guide
created: 2026-02-25
updated: 2026-02-25
title: "НАЛАШТУВАННЯ_ТА_РОЗГОРТАННЯ"
dg-publish: true
---

# BLOOM Runtime — Налаштування та розгортання

> Створено: 2026-02-25
> Статус: Canonical
> Мова: Українська (canonical)
> Аудиторія: DevOps, системний адміністратор

---

## Зміст

1. [Вимоги](#вимоги)
2. [Режими розгортання](#режими-розгортання)
3. [Розгортання для розробки (Replit)](#розгортання-для-розробки-replit)
4. [Production розгортання (Alpine Linux)](#production-розгортання-alpine-linux)
5. [Конфігурація Membridge](#конфігурація-membridge)
6. [Реєстрація Workers](#реєстрація-workers)
7. [Операційні команди](#операційні-команди)
8. [Оновлення та міграція](#оновлення-та-міграція)
9. [Backup та відновлення](#backup-та-відновлення)

---

## Вимоги

### Мінімальні

| Компонент | Версія | Призначення |
|-----------|--------|-------------|
| Node.js | >= 18 | Сервер BLOOM Runtime |
| PostgreSQL | >= 14 | Персистентне сховище |
| npm | >= 9 | Менеджер пакетів |

### Для повної функціональності

| Компонент | Версія | Призначення |
|-----------|--------|-------------|
| Python | >= 3.10 | Membridge Control Plane |
| MinIO | latest | Об'єктне сховище |
| nginx | >= 1.24 | Reverse proxy |
| certbot | latest | TLS сертифікати |

---

## Режими розгортання

```
┌──────────────────────────────────────────────────────────┐
│                    Режими розгортання                     │
│                                                          │
│  ┌───────────────┐  ┌───────────────┐  ┌──────────────┐ │
│  │   Розробка    │  │  Standalone   │  │  Production  │ │
│  │   (Replit)    │  │  (один сервер)│  │  (кластер)   │ │
│  ├───────────────┤  ├───────────────┤  ├──────────────┤ │
│  │ npm run dev   │  │ npm run build │  │ nginx + node │ │
│  │ Vite HMR      │  │ node dist/    │  │ systemd/     │ │
│  │ PostgreSQL    │  │   index.cjs   │  │  OpenRC      │ │
│  │ Без Membridge │  │ PostgreSQL    │  │ PostgreSQL   │ │
│  │ Auth вимкнено │  │ Membridge opt │  │ Membridge    │ │
│  └───────────────┘  └───────────────┘  │ Workers      │ │
│                                        │ MinIO        │ │
│                                        │ TLS          │ │
│                                        └──────────────┘ │
└──────────────────────────────────────────────────────────┘
```

---

## Розгортання для розробки (Replit)

### Крок 1: Запуск

Workflow "Start application" автоматично виконує `npm run dev`.

### Крок 2: Міграція БД

```bash
npm run db:push
```

### Крок 3: Перевірка

```bash
curl http://localhost:5000/api/runtime/health
```

### Особливості Replit

- Membridge Control Plane **не запущений** → `/api/membridge/*` повертає 502
- `RUNTIME_API_KEY` не встановлений → auth вимкнений
- PostgreSQL доступний через `DATABASE_URL` (автоматично)
- Vite HMR для фронтенду (автоматичне перезавантаження)

---

## Production розгортання (Alpine Linux)

### Топологія

```
                    ┌─────────────────┐
                    │  Internet/LAN   │
                    └────────┬────────┘
                             │ :80 / :443
                             ▼
┌────────────────────────────────────────────────────────┐
│                  Alpine Linux Server                    │
│                                                        │
│  ┌───────────────────────────────────────────────┐     │
│  │  nginx (reverse proxy)                         │     │
│  │  /etc/nginx/http.d/bloom-runtime.conf          │     │
│  └────────────────────┬──────────────────────────┘     │
│                       │ proxy_pass :5000               │
│                       ▼                                │
│  ┌───────────────────────────────────────────────┐     │
│  │  bloom-runtime (Node.js)                       │     │
│  │  /etc/init.d/bloom-runtime (OpenRC)            │     │
│  │  /etc/bloom-runtime.env (секрети)              │     │
│  │  /home/vokov/membridge/dist/index.cjs          │     │
│  └────────────────────┬──────────────────────────┘     │
│                       │ HTTP :8000                     │
│                       ▼                                │
│  ┌───────────────────────────────────────────────┐     │
│  │  membridge-server (Python/FastAPI)             │     │
│  │  /etc/init.d/membridge-server (OpenRC)         │     │
│  └───────────────────────────────────────────────┘     │
│                                                        │
│  ┌────────────────┐  ┌────────────────────────────┐    │
│  │  PostgreSQL    │  │  MinIO (:9000)              │    │
│  │  (:5432)       │  │  /data/minio               │    │
│  └────────────────┘  └────────────────────────────┘    │
└────────────────────────────────────────────────────────┘
```

### Крок 1: Побудова

```bash
cd /home/vokov/membridge
npm install
npm run build
```

Створює:
- `dist/index.cjs` — серверний bundle (~922 KB)
- `dist/public/` — React SPA (JS ~93 KB gzip, CSS ~11 KB gzip)

### Крок 2: Конфігурація середовища

Файл `/etc/bloom-runtime.env` (chmod 600):

```bash
NODE_ENV=production
PORT=5000
DATABASE_URL=postgresql://bloom:password@127.0.0.1:5432/bloom_runtime
MEMBRIDGE_SERVER_URL=http://127.0.0.1:8000
MEMBRIDGE_ADMIN_KEY=<згенеруйте-надійний-ключ>
RUNTIME_API_KEY=<згенеруйте-надійний-ключ>
```

### Крок 3: Міграція БД

```bash
npm run db:push
```

### Крок 4: OpenRC сервіс

Файл `/etc/init.d/bloom-runtime`:

```bash
#!/sbin/openrc-run
command="/usr/bin/node"
command_args="/home/vokov/membridge/dist/index.cjs"
command_user="vokov:vokov"
pidfile="/run/bloom-runtime.pid"
directory="/home/vokov/membridge"

depend() {
    need net
    after firewall
}

start_pre() {
    [ -f "$directory/dist/index.cjs" ] || return 1
}
```

### Крок 5: Запуск

```bash
sudo rc-service bloom-runtime start
sudo rc-update add bloom-runtime default    # автозапуск
```

### Крок 6: nginx

Файл `/etc/nginx/http.d/bloom-runtime.conf`:

```nginx
upstream bloom_runtime {
    server 127.0.0.1:5000;
    keepalive 32;
}

server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://bloom_runtime;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

```bash
sudo nginx -t && sudo nginx -s reload
```

---

## Конфігурація Membridge

### Через UI (рекомендований спосіб)

1. Відкрити Runtime → Membridge Proxy
2. Ввести URL: `http://127.0.0.1:8000`
3. Ввести Admin Key
4. Save → Test Connection

### Через API

```bash
curl -X POST http://localhost:5000/api/runtime/config \
  -H 'Content-Type: application/json' \
  -H 'X-Runtime-API-Key: <key>' \
  -d '{
    "membridge_server_url": "http://127.0.0.1:8000",
    "membridge_admin_key": "<admin-key>"
  }'
```

### Через змінні середовища

```bash
MEMBRIDGE_SERVER_URL=http://127.0.0.1:8000
MEMBRIDGE_ADMIN_KEY=<key>
```

Пріоритет: API/UI конфігурація > змінні середовища > значення за замовчуванням.

---

## Реєстрація Workers

### Передумови

Worker — це машина з встановленим Claude CLI та мережевим доступом до Membridge (:8000).

### Схема реєстрації

```
Worker Node                      Membridge (:8000)              BLOOM Runtime
┌──────────┐                    ┌──────────────┐               ┌──────────────┐
│          │──POST /agents─────▶│              │               │              │
│ Claude   │  {name, status,   │  Реєстрація  │               │              │
│ CLI      │   capabilities}   │  агента      │               │              │
│          │                   │              │◀──GET /agents──│ Worker Sync  │
│          │                   │              │  (кожні 10с)   │ (авто)       │
│          │                   │              │──────────────▶│              │
│          │                   │              │  [{worker}]    │  Upsert в    │
│          │                   │              │               │  PostgreSQL  │
└──────────┘                   └──────────────┘               └──────────────┘
```

### Реєстрація

```bash
curl -X POST http://<membridge-host>:8000/agents \
  -H 'X-MEMBRIDGE-ADMIN: <admin-key>' \
  -H 'Content-Type: application/json' \
  -d '{
    "name": "worker-rpi4b",
    "status": "online",
    "capabilities": {
      "claude_cli": true,
      "max_concurrency": 1,
      "labels": ["production", "arm64"]
    }
  }'
```

### Перевірка

```bash
# Через Membridge напряму
curl http://<membridge-host>:8000/agents \
  -H 'X-MEMBRIDGE-ADMIN: <admin-key>'

# Через BLOOM Runtime (після 10с auto-sync)
curl http://localhost:5000/api/runtime/workers \
  -H 'X-Runtime-API-Key: <key>'
```

### Capabilities (можливості)

| Поле | Тип | Опис |
|------|-----|------|
| `claude_cli` | boolean | Чи має worker Claude CLI |
| `max_concurrency` | number | Максимум одночасних завдань |
| `labels` | string[] | Теги для маршрутизації |

---

## Операційні команди

### Управління сервісом (Alpine/OpenRC)

```bash
sudo rc-service bloom-runtime start
sudo rc-service bloom-runtime stop
sudo rc-service bloom-runtime restart
sudo rc-service bloom-runtime status
```

### Перебудова та рестарт

```bash
cd /home/vokov/membridge
npm install
npm run build
sudo rc-service bloom-runtime restart
```

### Логи

```bash
sudo tail -f /var/log/bloom-runtime.log          # stdout
sudo tail -f /var/log/bloom-runtime-error.log     # stderr
```

### Діагностика

```bash
# Health
curl -s http://localhost:5000/api/runtime/health | jq .

# Статистика
curl -s http://localhost:5000/api/runtime/stats \
  -H 'X-Runtime-API-Key: <key>' | jq .

# Audit log
curl -s http://localhost:5000/api/runtime/audit?limit=10 \
  -H 'X-Runtime-API-Key: <key>' | jq .

# Membridge з'єднання
curl -s -X POST http://localhost:5000/api/runtime/test-connection | jq .
```

---

## Оновлення та міграція

### Оновлення коду

```bash
cd /home/vokov/membridge
git pull origin main
npm install
npm run build
npm run db:push              # застосувати зміни схеми
sudo rc-service bloom-runtime restart
```

### Міграція бази даних

```bash
npm run db:push
```

Drizzle Kit автоматично визначає дельту між поточною схемою та БД, і застосовує зміни.

### Rollback

Якщо оновлення не вдалось:

```bash
git checkout <previous-commit>
npm install
npm run build
npm run db:push
sudo rc-service bloom-runtime restart
```

---

## Backup та відновлення

### PostgreSQL

```bash
# Backup
pg_dump $DATABASE_URL > bloom_runtime_backup_$(date +%Y%m%d).sql

# Відновлення
psql $DATABASE_URL < bloom_runtime_backup_20260225.sql
```

### MinIO (claude-mem.db)

```bash
# Backup через mc (MinIO Client)
mc cp myminio/claude-mem/ ./backup/ --recursive

# Відновлення
mc cp ./backup/ myminio/claude-mem/ --recursive
```

### Конфігурація

```bash
# Backup
sudo cp /etc/bloom-runtime.env /etc/bloom-runtime.env.backup

# Відновлення
sudo cp /etc/bloom-runtime.env.backup /etc/bloom-runtime.env
sudo rc-service bloom-runtime restart
```

---

## Семантичні зв'язки

**Цей документ залежить від:**
- [[operations/RUNTIME_DEPLOYMENT_STATE_ALPINE.md]] — канонічний стан розгортання
- [[operations/RUNTIME_BACKEND_IMPLEMENTATION_STATE.md]] — деталі реалізації

**На цей документ посилаються:**
- [[../ІНДЕКС.md]] — головний індекс документації
- [[ПОСІБНИК_КОРИСТУВАЧА_BLOOM_RUNTIME.md]] — посібник користувача
