<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Membridge</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font: 14px/1.5 system-ui, sans-serif; background: #0f1117; color: #e2e8f0; }
a { color: #7c9dff; text-decoration: none; }
a:hover { text-decoration: underline; }

.header {
  background: #1a1f2e; border-bottom: 1px solid #2d3748;
  padding: 12px 20px; display: flex; align-items: center; gap: 12px;
}
.header h1 { font-size: 16px; font-weight: 600; }
.badge { background: #2d6a4f; color: #74c69d; font-size: 11px; padding: 2px 8px; border-radius: 4px; }
.header-links { margin-left: auto; font-size: 12px; color: #64748b; }

.keybar {
  background: #161b27; border-bottom: 1px solid #2d3748;
  padding: 10px 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
}
.keybar label { font-size: 12px; color: #94a3b8; white-space: nowrap; }
.keybar input {
  flex: 1; max-width: 340px; background: #0f1117; border: 1px solid #374151;
  color: #e2e8f0; padding: 6px 10px; border-radius: 6px;
  font-family: monospace; font-size: 12px;
}
.keybar input:focus { outline: none; border-color: #7c9dff; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: #4a5568; flex-shrink: 0; }
.status-dot.ok  { background: #4ade80; }
.status-dot.err { background: #f87171; }
#keyMsg { font-size: 12px; color: #94a3b8; }

.layout { display: flex; height: calc(100vh - 97px); }

.sidebar { width: 280px; min-width: 220px; border-right: 1px solid #2d3748; overflow-y: auto; flex-shrink: 0; }
.sidebar-header {
  padding: 10px 16px; border-bottom: 1px solid #2d3748;
  display: flex; justify-content: space-between; align-items: center;
}
.sidebar-header span { font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: .05em; }
.proj-item { padding: 10px 16px; border-bottom: 1px solid #1e2535; cursor: pointer; transition: background .1s; }
.proj-item:hover { background: #1e2535; }
.proj-item.active { background: #1e3a5f; border-left: 3px solid #7c9dff; padding-left: 13px; }
.proj-name { font-weight: 500; font-size: 13px; }
.proj-cid  { font-family: monospace; font-size: 11px; color: #64748b; margin-top: 2px; }
.empty { padding: 20px 16px; color: #4a5568; font-size: 12px; text-align: center; }

.main { flex: 1; overflow-y: auto; padding: 20px; }
.placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #4a5568; gap: 10px; }
.placeholder .icon { font-size: 48px; opacity: .5; }

.section { background: #1a1f2e; border: 1px solid #2d3748; border-radius: 8px; margin-bottom: 16px; }
.section-header { padding: 11px 16px; border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between; align-items: center; }
.section-title  { font-size: 13px; font-weight: 600; }
.section-body   { padding: 16px; }

table { width: 100%; border-collapse: collapse; font-size: 12px; }
th { text-align: left; padding: 6px 10px; color: #64748b; font-weight: 500; border-bottom: 1px solid #2d3748; }
td { padding: 8px 10px; border-bottom: 1px solid #1e2535; vertical-align: top; }
tr:last-child td { border-bottom: none; }

.badge-role { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.badge-role.primary   { background: #1a3a5f; color: #7c9dff; }
.badge-role.secondary { background: #1a2a1a; color: #4ade80; }
.badge-role.unknown   { background: #2d3748; color: #94a3b8; }

.mono { font-family: monospace; }
.rel-time { color: #64748b; font-size: 11px; }

.info-grid { display: grid; grid-template-columns: auto 1fr; gap: 6px 16px; font-size: 13px; }
.info-label { color: #64748b; white-space: nowrap; }
.info-value { font-family: monospace; word-break: break-all; }
.info-value.hi { color: #7c9dff; font-weight: 600; }

.form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; flex-wrap: wrap; }
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-group label { font-size: 11px; color: #94a3b8; }
.form-group input {
  background: #0f1117; border: 1px solid #374151; color: #e2e8f0;
  padding: 7px 10px; border-radius: 6px; font-family: monospace; font-size: 12px; min-width: 220px;
}
.form-group input:focus { outline: none; border-color: #7c9dff; }
.form-group input.narrow { min-width: 90px; }

button {
  cursor: pointer; border: none; border-radius: 6px; padding: 7px 14px;
  font-size: 12px; font-weight: 500; transition: opacity .15s; white-space: nowrap;
}
button:hover:not(:disabled) { opacity: .82; }
button:active:not(:disabled) { opacity: .65; }
button.primary { background: #3b6bef; color: #fff; }
button.ghost   { background: #2d3748; color: #e2e8f0; }
button.sm { padding: 4px 10px; font-size: 11px; }
button:disabled { opacity: .4; cursor: not-allowed; }

.alert { padding: 10px 14px; border-radius: 6px; font-size: 12px; margin-top: 10px; }
.alert.success { background: #1a3a2a; color: #4ade80; border: 1px solid #166534; }
.alert.error   { background: #3a1a1a; color: #f87171; border: 1px solid #7f1d1d; }

.spinner {
  display: inline-block; width: 14px; height: 14px;
  border: 2px solid #374151; border-top-color: #7c9dff;
  border-radius: 50%; animation: spin .7s linear infinite; vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="header">
  <h1>Membridge</h1>
  <span class="badge">control-plane</span>
  <div class="header-links">
    <a href="/docs" target="_blank">/docs</a> &nbsp;·&nbsp;
    <a href="/health" target="_blank">/health</a>
  </div>
</div>

<div class="keybar">
  <label for="adminKey">Admin Key</label>
  <input type="password" id="adminKey" placeholder="X-MEMBRIDGE-ADMIN value" autocomplete="off">
  <span class="status-dot" id="keyDot"></span>
  <button class="ghost sm" onclick="saveKey()">Save</button>
  <button class="ghost sm" onclick="testKey()">Test</button>
  <span id="keyMsg"></span>
</div>

<div class="layout">
  <div class="sidebar">
    <div class="sidebar-header">
      <span>Projects</span>
      <button class="ghost sm" onclick="loadProjects()" title="Refresh">↻</button>
    </div>
    <div id="projectList">
      <div class="empty">Enter admin key and click Save</div>
    </div>
  </div>

  <div class="main" id="main">
    <div class="placeholder">
      <div class="icon">⬡</div>
      <div>Select a project from the sidebar</div>
    </div>
  </div>
</div>

<script>
'use strict';

/* ── State ── */
let adminKey = sessionStorage.getItem('mb_admin_key') || '';
let selectedCid = null;
let autoTimer = null;

/* ── Boot ── */
window.addEventListener('DOMContentLoaded', () => {
  if (adminKey) {
    document.getElementById('adminKey').value = adminKey;
    dot('ok');
    loadProjects();
  }
});

/* ── Admin key ── */
function saveKey() {
  adminKey = document.getElementById('adminKey').value.trim();
  sessionStorage.setItem('mb_admin_key', adminKey);
  dot('ok');
  msg('Saved.', 2000);
  loadProjects();
}

async function testKey() {
  try {
    const r = await api('/health');
    dot('ok');
    msg('✓ ' + r.service + ' ' + r.version);
  } catch (e) {
    dot('err');
    msg('✗ ' + e.message);
  }
}

function dot(state) {
  document.getElementById('keyDot').className = 'status-dot ' + state;
}

function msg(text, clearMs) {
  const el = document.getElementById('keyMsg');
  el.textContent = text;
  if (clearMs) setTimeout(() => { el.textContent = ''; }, clearMs);
}

/* ── API ── */
async function api(path, opts) {
  opts = opts || {};
  const headers = { 'Content-Type': 'application/json' };
  if (adminKey) headers['X-MEMBRIDGE-ADMIN'] = adminKey;
  Object.assign(headers, opts.headers || {});
  const res = await fetch(path, { ...opts, headers });
  if (!res.ok) {
    let detail = 'HTTP ' + res.status;
    try { detail = (await res.json()).detail || detail; } catch (_) {}
    throw new Error(detail);
  }
  return res.json();
}

/* ── Projects sidebar ── */
async function loadProjects() {
  const el = document.getElementById('projectList');
  el.innerHTML = '<div class="empty"><span class="spinner"></span></div>';
  try {
    const list = await api('/projects');
    if (!list.length) {
      el.innerHTML = '<div class="empty">No projects yet.<br>Create one via API or /docs.</div>';
      return;
    }
    el.innerHTML = list.map(p => `
      <div class="proj-item${selectedCid === p.canonical_id ? ' active' : ''}"
           onclick="selectProject('${esc(p.canonical_id)}','${esc(p.name)}')">
        <div class="proj-name">${esc(p.name)}</div>
        <div class="proj-cid">${esc(p.canonical_id)}</div>
      </div>`).join('');
  } catch (e) {
    dot('err');
    el.innerHTML = `<div class="empty" style="color:#f87171">${esc(e.message)}</div>`;
  }
}

/* ── Project detail ── */
function selectProject(cid, name) {
  selectedCid = cid;
  clearInterval(autoTimer);

  document.querySelectorAll('.proj-item').forEach(el => {
    const cidEl = el.querySelector('.proj-cid');
    el.classList.toggle('active', cidEl && cidEl.textContent === cid);
  });

  document.getElementById('main').innerHTML = `
    <div style="margin-bottom:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <span style="font-size:15px;font-weight:600">${esc(name)}</span>
      <span class="mono" style="font-size:12px;color:#64748b">${esc(cid)}</span>
      <button class="ghost sm" onclick="refreshAll('${esc(cid)}')">↻ Refresh</button>
      <span id="autoLabel" style="font-size:11px;color:#4a5568">auto-refresh 10s</span>
    </div>

    <div class="section">
      <div class="section-header">
        <span class="section-title">Leadership</span>
      </div>
      <div class="section-body" id="leadershipBody"><span class="spinner"></span></div>
    </div>

    <div class="section">
      <div class="section-header">
        <span class="section-title">Nodes</span>
        <span id="nodeCount" style="font-size:11px;color:#64748b"></span>
      </div>
      <div class="section-body" id="nodesBody"><span class="spinner"></span></div>
    </div>

    <div class="section">
      <div class="section-header">
        <span class="section-title">Promote Primary</span>
      </div>
      <div class="section-body">
        <div class="form-row">
          <div class="form-group">
            <label>Node ID</label>
            <input type="text" id="promoteNodeId" placeholder="node-id or hostname">
          </div>
          <div class="form-group">
            <label>Lease (s)</label>
            <input type="number" id="promoteLease" value="3600" class="narrow">
          </div>
          <button class="primary" onclick="promoteNode('${esc(cid)}')">Promote</button>
        </div>
        <div id="promoteResult"></div>
      </div>
    </div>
  `;

  refreshAll(cid);
  autoTimer = setInterval(() => refreshAll(cid), 10000);
}

function refreshAll(cid) {
  if (selectedCid !== cid) return;
  loadLeadership(cid);
  loadNodes(cid);
}

/* ── Leadership ── */
async function loadLeadership(cid) {
  const el = document.getElementById('leadershipBody');
  if (!el) return;
  try {
    const l = await api('/projects/' + cid + '/leadership');
    el.innerHTML = `
      <div class="info-grid">
        <span class="info-label">Preferred primary</span>
        <span class="info-value hi">${l.preferred_primary ? esc(l.preferred_primary) : '—'}</span>
        <span class="info-label">Node count</span>
        <span class="info-value">${l.node_count}</span>
        <span class="info-label">canonical_id</span>
        <span class="info-value">${esc(l.canonical_id)}</span>
      </div>`;
  } catch (e) {
    el.innerHTML = `<span style="color:#f87171;font-size:12px">${esc(e.message)}</span>`;
  }
}

/* ── Nodes ── */
async function loadNodes(cid) {
  const el = document.getElementById('nodesBody');
  const cntEl = document.getElementById('nodeCount');
  if (!el) return;
  try {
    const nodes = await api('/projects/' + cid + '/nodes');
    if (cntEl) cntEl.textContent = nodes.length + ' node' + (nodes.length !== 1 ? 's' : '');
    if (!nodes.length) {
      el.innerHTML = '<span style="color:#64748b;font-size:12px">No heartbeats received yet.</span>';
      return;
    }
    el.innerHTML = `
      <table>
        <thead><tr>
          <th>Node ID</th><th>Role</th><th>obs_count</th>
          <th>db_sha</th><th>Last seen</th><th>IPs</th>
        </tr></thead>
        <tbody>
          ${nodes.map(n => `
          <tr>
            <td class="mono">${esc(n.node_id)}</td>
            <td><span class="badge-role ${esc(n.role)}">${esc(n.role)}</span></td>
            <td>${n.obs_count != null ? n.obs_count : '—'}</td>
            <td class="mono" style="font-size:11px">${n.db_sha ? esc(n.db_sha.slice(0,12)) + '…' : '—'}</td>
            <td class="rel-time">${relTime(n.last_seen)}</td>
            <td class="mono" style="font-size:11px">${(n.ip_addrs || []).map(esc).join('<br>') || '—'}</td>
          </tr>`).join('')}
        </tbody>
      </table>`;
  } catch (e) {
    el.innerHTML = `<span style="color:#f87171;font-size:12px">${esc(e.message)}</span>`;
  }
}

/* ── Promote ── */
async function promoteNode(cid) {
  const nodeId = document.getElementById('promoteNodeId').value.trim();
  const lease  = parseInt(document.getElementById('promoteLease').value, 10) || 3600;
  const resEl  = document.getElementById('promoteResult');

  if (!nodeId) {
    resEl.innerHTML = '<div class="alert error">Node ID is required.</div>';
    return;
  }
  try {
    const r = await api('/projects/' + cid + '/leadership/select', {
      method: 'POST',
      body: JSON.stringify({ primary_node_id: nodeId, lease_seconds: lease }),
    });
    resEl.innerHTML = `<div class="alert success">✓ ${esc(r.detail)}</div>`;
    refreshAll(cid);
  } catch (e) {
    resEl.innerHTML = `<div class="alert error">✗ ${esc(e.message)}</div>`;
  }
}

/* ── Helpers ── */
function esc(s) {
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function relTime(ts) {
  if (!ts) return '—';
  const ago = Math.round(Date.now() / 1000 - ts);
  if (ago < 60)   return ago + 's ago';
  if (ago < 3600) return Math.round(ago / 60) + 'm ago';
  return Math.round(ago / 3600) + 'h ago';
}
</script>
</body>
</html>
