#!/bin/bash
# Hook wrapper for SessionStart — pulls DB from MinIO
# Fail-open: always exit 0 so Claude CLI session starts even on errors
# Safe mode: does NOT restart worker (worker starts with Claude CLI session)
set +e

MEMBRIDGE_DIR="${MEMBRIDGE_DIR:-$HOME/membridge}"
LOG=~/.claude-mem-minio/hook.log

{
echo "=== $(date) START pull ==="
set -a
source "$MEMBRIDGE_DIR/config.env"
set +a
"$MEMBRIDGE_DIR/validate-env.sh" || { echo "ENV VALIDATION FAILED"; exit 0; }

# Best-effort: register project in membridge agent (fail-open, no output on error)
if [ -n "$CLAUDE_PROJECT_ID" ]; then
  curl -sf -X POST http://127.0.0.1:8001/register_project \
    -H "Content-Type: application/json" \
    -d "{\"project_id\":\"$CLAUDE_PROJECT_ID\"}" \
    >/dev/null 2>&1 || true
  echo "register_project: $CLAUDE_PROJECT_ID (agent may not be running — ok)"
fi
export PATH="$HOME/npm-global/bin:$PATH"
source "$MEMBRIDGE_DIR/venv/bin/activate"
export MEMBRIDGE_NO_RESTART_WORKER=1
python "$MEMBRIDGE_DIR/sqlite_minio_sync.py" pull_sqlite
echo "=== $(date) END pull rc=$? ==="
} >> "$LOG" 2>&1

exit 0
