#!/bin/bash
# Hook wrapper for SessionStart â€” pulls DB from MinIO
# Fail-open: always exit 0 so Claude CLI session starts even on errors
# Safe mode: does NOT restart worker (worker starts with Claude CLI session)
set +e

MEMBRIDGE_DIR="${MEMBRIDGE_DIR:-$HOME/membridge}"
LOG=~/.claude-mem-minio/hook.log

{
echo "=== $(date) START pull ==="
set -a
source "$MEMBRIDGE_DIR/config.env"
set +a
"$MEMBRIDGE_DIR/validate-env.sh" || { echo "ENV VALIDATION FAILED"; exit 0; }
export PATH="$HOME/npm-global/bin:$PATH"
source "$MEMBRIDGE_DIR/venv/bin/activate"
export MEMBRIDGE_NO_RESTART_WORKER=1
python "$MEMBRIDGE_DIR/sqlite_minio_sync.py" pull_sqlite
echo "=== $(date) END pull rc=$? ==="
} >> "$LOG" 2>&1

exit 0
