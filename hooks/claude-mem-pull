#!/bin/bash
# Manual pull â€” interactive, shows output in terminal
# Usage: claude-mem-pull [--project <name>] [--no-restart-worker]
set -euo pipefail

MEMBRIDGE_DIR="${MEMBRIDGE_DIR:-$HOME/membridge}"

# CLI env overrides config.env
OV_ALLOW_PRIMARY_PULL_OVERRIDE="${ALLOW_PRIMARY_PULL_OVERRIDE-__unset__}"
OV_STALE_LOCK_GRACE_SECONDS="${STALE_LOCK_GRACE_SECONDS-__unset__}"

set -a
source "$MEMBRIDGE_DIR/config.env"
set +a

[ "$OV_ALLOW_PRIMARY_PULL_OVERRIDE" != "__unset__" ] && export ALLOW_PRIMARY_PULL_OVERRIDE="$OV_ALLOW_PRIMARY_PULL_OVERRIDE"
[ "$OV_STALE_LOCK_GRACE_SECONDS" != "__unset__" ]    && export STALE_LOCK_GRACE_SECONDS="$OV_STALE_LOCK_GRACE_SECONDS"

while [[ $# -gt 0 ]]; do
  case $1 in
    --project)
      export CLAUDE_PROJECT_ID="$2"
      shift 2
      ;;
    --no-restart-worker)
      export MEMBRIDGE_NO_RESTART_WORKER=1
      shift
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: claude-mem-pull [--project <name>] [--no-restart-worker]"
      exit 1
      ;;
  esac
done

"$MEMBRIDGE_DIR/validate-env.sh"

source "$MEMBRIDGE_DIR/venv/bin/activate"
export PATH="$HOME/npm-global/bin:$PATH"
python "$MEMBRIDGE_DIR/sqlite_minio_sync.py" pull_sqlite
