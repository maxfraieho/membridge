#!/bin/bash
# Manual push â€” interactive, shows output in terminal
# Usage: claude-mem-push [--project <name>]
set -euo pipefail

MEMBRIDGE_DIR="${MEMBRIDGE_DIR:-$HOME/membridge}"

# CLI env overrides config.env
OV_FORCE_PUSH="${FORCE_PUSH-__unset__}"
OV_ALLOW_SECONDARY_PUSH="${ALLOW_SECONDARY_PUSH-__unset__}"
OV_STALE_LOCK_GRACE_SECONDS="${STALE_LOCK_GRACE_SECONDS-__unset__}"

set -a
source "$MEMBRIDGE_DIR/config.env"
set +a

[ "$OV_FORCE_PUSH" != "__unset__" ]               && export FORCE_PUSH="$OV_FORCE_PUSH"
[ "$OV_ALLOW_SECONDARY_PUSH" != "__unset__" ]     && export ALLOW_SECONDARY_PUSH="$OV_ALLOW_SECONDARY_PUSH"
[ "$OV_STALE_LOCK_GRACE_SECONDS" != "__unset__" ] && export STALE_LOCK_GRACE_SECONDS="$OV_STALE_LOCK_GRACE_SECONDS"

while [[ $# -gt 0 ]]; do
  case $1 in
    --project)
      export CLAUDE_PROJECT_ID="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: claude-mem-push [--project <name>]"
      exit 1
      ;;
  esac
done

"$MEMBRIDGE_DIR/validate-env.sh"

source "$MEMBRIDGE_DIR/venv/bin/activate"
export PATH="$HOME/npm-global/bin:$PATH"
python "$MEMBRIDGE_DIR/sqlite_minio_sync.py" push_sqlite
