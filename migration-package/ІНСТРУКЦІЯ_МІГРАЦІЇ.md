# Міграція BLOOM Runtime в NotebookLM Repl

## Що це

Цей пакет містить повний код BLOOM Runtime бекенду (Express/TypeScript), який потрібно інтегрувати в NotebookLM Repl. Після інтеграції NotebookLM Repl стане повним BLOOM Backend з трьома сервісами:

1. **NotebookLM Backend** (Python/FastAPI, порт 5000) — як є
2. **Memory Backend** (Node.js/Fastify, порт 3001) — як є
3. **BLOOM Runtime API** (Express, порт 3002) — **НОВИЙ**, з цього пакету

---

## Інструкція для тебе (крок за кроком)

### Крок 1: Підготовка

1. Відкрий NotebookLM Repl
2. Завантаж файл `BLOOM_RUNTIME_MIGRATION_BUNDLE.md` (він є в цьому ж пакеті) як прикріплення до чату

### Крок 2: Дай промпт агенту

Скопіюй текст з файлу `ПРОМПТ_ДЛЯ_АГЕНТА.md` і встав його в чат агенту в NotebookLM Repl разом з прикріпленим файлом `BLOOM_RUNTIME_MIGRATION_BUNDLE.md`.

### Крок 3: Що агент повинен зробити

Агент:
1. Створить директорію `bloom-runtime/` в проєкті
2. Скопіює всі TypeScript файли (schema, storage, routes, middleware, runtime клієнти)
3. Додасть необхідні npm пакети
4. Створить `bloom-runtime/server.ts` — окремий Express сервер на порту 3002
5. Оновить `.replit` щоб запускати третій сервер паралельно
6. Виконає `npm run db:push` для створення PostgreSQL таблиць

### Крок 4: Перевірка

Після інтеграції перевір:
```bash
# Health check
curl http://localhost:3002/api/runtime/health

# Створити task
curl -X POST http://localhost:3002/api/runtime/llm-tasks \
  -H "Content-Type: application/json" \
  -d '{"context_id":"test","agent_slug":"writer","prompt":"hello"}'

# Подивитись workers
curl http://localhost:3002/api/runtime/workers
```

### Крок 5: Фронтенд (garden-seedling)

Після того як бекенд працює, фронтенд (garden-seedling/Lovable) потрібно налаштувати на новий URL:
- Замість `http://this-repl:5000/api/runtime/*`
- Тепер `http://notebooklm-repl:3002/api/runtime/*`

Або додати proxy в Cloudflare Worker.

---

## Що буде перенесено

### Нові файли (створити в NotebookLM Repl)
```
bloom-runtime/
├── server.ts              — Express сервер (порт 3002)
├── db.ts                  — Drizzle ORM + PostgreSQL
├── storage.ts             — DatabaseStorage (IStorage)
├── routes.ts              — API endpoints
├── schema.ts              — Drizzle pgTable + TypeScript types + Zod schemas
├── middleware/
│   └── runtimeAuth.ts     — X-Runtime-API-Key auth
├── runtime/
│   ├── membridgeClient.ts — HTTP клієнт з retry/backoff
│   ├── workerSync.ts      — Auto-sync workers кожні 10с
│   └── minioArtifacts.ts  — MinIO upload/download
└── drizzle.config.ts      — Drizzle Kit config
```

### NPM пакети (додати)
```
express express-rate-limit drizzle-orm drizzle-zod drizzle-kit pg minio
@types/express @types/pg
```

### Environment Variables (перевірити/додати)
```
DATABASE_URL              — PostgreSQL (вже має бути)
RUNTIME_API_KEY           — опціонально, для auth
MEMBRIDGE_SERVER_URL      — URL Membridge control plane
MEMBRIDGE_ADMIN_KEY       — ключ адміна Membridge
MINIO_ENDPOINT            — MinIO сервер (вже має бути)
MINIO_PORT                — порт MinIO
MINIO_ACCESS_KEY          — MinIO ключ (вже має бути)
MINIO_SECRET_KEY          — MinIO секрет (вже має бути)
MINIO_ARTIFACT_BUCKET     — bucket для артефактів (default: bloom-artifacts)
MINIO_USE_SSL             — true/false
```

---

## API Endpoints (що з'явиться на порту 3002)

### Runtime API
| Method | Path | Description |
|--------|------|-------------|
| GET | /api/runtime/health | Service health |
| GET | /api/runtime/config | Get Membridge config |
| POST | /api/runtime/config | Save config |
| POST | /api/runtime/test-connection | Test Membridge |
| GET | /api/runtime/workers | List workers |
| GET | /api/runtime/workers/:id | Worker detail |
| POST | /api/runtime/workers | Register worker |
| DELETE | /api/runtime/workers/:id | Remove worker |
| POST | /api/runtime/llm-tasks | Create task |
| GET | /api/runtime/llm-tasks | List tasks |
| GET | /api/runtime/llm-tasks/:id | Task detail |
| POST | /api/runtime/llm-tasks/:id/lease | Lease task to worker |
| POST | /api/runtime/llm-tasks/:id/heartbeat | Renew lease |
| POST | /api/runtime/llm-tasks/:id/complete | Complete task |
| POST | /api/runtime/llm-tasks/:id/requeue | Requeue failed |
| GET | /api/runtime/leases | List leases |
| GET | /api/runtime/runs | Recent runs |
| GET | /api/runtime/artifacts | List artifacts |
| GET | /api/runtime/audit | Audit log |
| GET | /api/runtime/stats | Dashboard stats |

### Membridge Proxy
| Method | Path | Description |
|--------|------|-------------|
| GET | /api/membridge/health | Proxy to Membridge |
| GET | /api/membridge/projects | List projects |
| GET | /api/membridge/projects/:cid/leadership | Leadership lease |
| GET | /api/membridge/projects/:cid/nodes | Project nodes |
| POST | /api/membridge/projects/:cid/leadership/select | Promote primary |

---

## Критичні інваріанти

1. **Два шари пам'яті НІКОЛИ не змішуються:**
   - `claude-mem.db` (Membridge → MinIO, session sync)
   - `DiffMem/git` (agent reasoning, Proposal/Apply only)

2. **Workers ніколи не пишуть напряму в canonical storage** — повертають тільки results/proposals

3. **Admin key ніколи не потрапляє у фронтенд** — backend інжектує X-MEMBRIDGE-ADMIN через membridgeFetch()

4. **Lease TTL 300s** — stale leases expire і requeue tasks (max 3 attempts → dead)
